package main

import (
	"html/template"
	"net/http"
	"os"
	"path/filepath"

	"github.com/gin-gonic/gin"
)

func loadTemplates(pattern string) *template.Template {
	tmpl := template.New("")

	_ = filepath.Walk(pattern, func(path string, info os.FileInfo, err error) error {
		if err != nil {
			return err
		}

		if !info.IsDir() && filepath.Ext(path) == ".html" {
			_, err = tmpl.ParseFiles(path)
			if err != nil {
				panic(err)
			}
		}
		return nil
	})

	return tmpl
}

func main() {
	r := gin.Default()

	// Load all templates from templates/ recursively
	tmpl := loadTemplates("templates")
	r.SetHTMLTemplate(tmpl)

	// Serve static files
	r.Static("/assets", "./assets")

	// Routes
	r.GET("/login", func(c *gin.Context) {
		c.HTML(http.StatusOK, "login.html", nil)
	})

	r.GET("/admin", func(c *gin.Context) {
		c.HTML(http.StatusOK, "admin-main.html", nil)
	})

	r.GET("/user", func(c *gin.Context) {
		c.HTML(http.StatusOK, "user-main.html", nil)
	})

	r.GET("/executor", func(c *gin.Context) {
		c.HTML(http.StatusOK, "executor-main.html", nil)
	})

	r.GET("/auditor", func(c *gin.Context) {
		c.HTML(http.StatusOK, "auditor-main.html", nil)
	})

	r.POST("/login", func(c *gin.Context) {
		email := c.PostForm("email")
		password := c.PostForm("password")

		if email != "" && password != "" {
			// pretend we logged in successfully
			if email[:5] == "admin" {
				c.Redirect(http.StatusFound, "/admin/main")
			}
			if email[:4] == "user" {
				c.Redirect(http.StatusFound, "/user/main")
			}
			if email[:8] == "executor" {
				c.Redirect(http.StatusFound, "/executor/main")
			}
			if email[:7] == "auditor" {
				c.Redirect(http.StatusFound, "/auditor/main")
			}
			return
		}

		// if sum's wrong, reload login
		c.HTML(http.StatusUnauthorized, "login.html", gin.H{
			"error": "Неверный логин или пароль",
		})
	})

	// --- API routes returning JSON objects ---

	// api/main/
	r.GET("/api/main", func(c *gin.Context) {
		c.JSON(http.StatusOK, gin.H{
			"Наименование": []string{"Отдел IT", "Отдел кадров", "Финансовый отдел", "Юридический отдел"},
			"Открыто":      []int{5, 3, 7, 2},
			"Закрыто":      []int{2, 1, 4, 1},
		})
	})

	// api/applications/
	r.GET("/api/applications", func(c *gin.Context) {
		c.JSON(http.StatusOK, gin.H{
			"№":                []string{"1023", "2045", "3098", "4120", "5234", "6345"},
			"Статус":           []string{"open", "closed", "working", "cancelled", "open", "working"},
			"Приоритет":        []string{"high", "low", "critical", "mid", "low", "high"},
			"Наименование":     []string{"Ошибка входа в систему", "Не работает принтер", "Запрос на доступ", "Сброс пароля", "Проблема с интернетом", "Ошибка ПО"},
			"Заявитель":        []string{"Иванов И.И.", "Петрова А.А.", "Сидоров В.В.", "Кузнецов Д.Д.", "Михайлова Т.Т.", "Григорьев С.С."},
			"Дата_заявителя":   []string{"2024-06-01 09:15", "2024-06-02 10:30", "2024-06-03 14:45", "2024-06-04 08:20", "2024-06-05 13:10", "2024-06-06 15:25"},
			"Исполнитель":      []string{"Смирнов К.К.", "Волкова Е.Е.", "Морозов С.С.", "Орлова Л.Л.", "Алексеев П.П.", "Дмитриева Н.Н."},
			"Дата_исполнителя": []string{"2024-06-01 11:00", "2024-06-02 12:00", "2024-06-03 16:00", "2024-06-04 09:00", "2024-06-05 14:00", "2024-06-06 16:30"},
		})
	})

	// api/users/
	r.GET("/api/users", func(c *gin.Context) {
		c.JSON(http.StatusOK, gin.H{
			"Имя":            []string{"Алишер Рахимов", "Фаррух Саидов", "Мехрубон Каримова", "Шахноза Назаров", "Малика Исмоилова", "Далер Мирзоев"},
			"Логин":          []string{"alisher.rahimov", "farrukh.saidov", "mehrubon.karimova", "shahnoza.nazarov", "malika.ismoilova", "daler.mirzoev"},
			"Подразделение":  []string{"Отдел IT", "Отдел кадров", "Финансовый отдел", "Юридический отдел", "Отдел IT", "Финансовый отдел"},
			"Системная Роль": []string{"admin", "user", "executor", "auditor", "user", "executor"},
			"Телефон":        []string{"+992 901234567", "+992 902345678", "+992 933456789", "+992 944567890", "+992 955678901", "+992 966789012"},
			"email":          []string{"alisher.rahimov@arvand.tj", "farrukh.saidov@arvand.tj", "mehrubon.karimova@arvand.tj", "shahnoza.nazarov@arvand.tj", "malika.ismoilova@arvand.tj", "daler.mirzoev@arvand.tj"},
		})
	})

	// api/handbook/statuses
	r.GET("/api/handbook/statuses", func(c *gin.Context) {
		c.JSON(http.StatusOK, gin.H{
			"Иконки":       []string{"icon1", "icon2", "icon3", "icon4", "icon5", "icon6", "icon7", "icon8", "icon9"},
			"Наименование": []string{"Открыто", "В работе", "Закрыто", "Отменено", "В ожидании", "Одобрено", "Отклонено", "На удержании", "Эскалировано"},
			"Тип":          []string{"active", "active", "final", "final", "pending", "final", "final", "pending", "escalated"},
		})
	})

	// api/handbook/priorities
	r.GET("/api/handbook/priorities", func(c *gin.Context) {
		c.JSON(http.StatusOK, gin.H{
			"Иконки":       []string{"icon-low", "icon-medium", "icon-high", "icon-critical"},
			"Наименование": []string{"Низкий", "Средний", "Высокий", "Критический"},
			"Тип":          []string{"low", "medium", "high", "critical"},
		})
	})

	// api/handbook/departments
	r.GET("/api/handbook/departments", func(c *gin.Context) {
		c.JSON(http.StatusOK, gin.H{
			"Наименование": []string{"Отдел IT", "Отдел кадров", "Финансовый отдел", "Юридический отдел"},
		})
	})

	// api/handbook/divisions
	r.GET("/api/handbook/divisions", func(c *gin.Context) {
		c.JSON(http.StatusOK, gin.H{
			"Наименование": []string{
				"Департамент информационных технологий",
				"Департамент кадров",
				"Департамент финансов",
				"Департамент юридических услуг",
				"Департамент обслуживания клиентов",
				"Департамент безопасности",
			},
		})
	})

	// api/handbook/branches
	r.GET("/api/handbook/branches", func(c *gin.Context) {
		c.JSON(http.StatusOK, gin.H{
			"Наименование":          []string{"Филиали марказӣ", "Филиали Исмоили Сомонӣ", "Филиали Фирдавсӣ", "Филиали Сино", "Филиали Шоҳмансур", "Филиали Вахдат", "Филиали Ҳисор", "Филиали Турсунзода", "Филиали Бохтар", "Филиали Хуҷанд", "Филиали Кӯлоб"},
			"Адрес":                 []string{"ш. Душанбе, кӯч. Рӯдакӣ 123", "ш. Душанбе, кӯч. Исмоили Сомонӣ 45", "ш. Душанбе, кӯч. Фирдавсӣ 67", "ш. Душанбе, кӯч. Сино 89", "ш. Душанбе, кӯч. Шоҳмансур 12", "ш. Вахдат, кӯч. Истиқлол 34", "ш. Ҳисор, кӯч. Наврӯз 56", "ш. Турсунзода, кӯч. Дӯстӣ 78", "ш. Бохтар, кӯч. Садриддин Айнӣ 90", "ш. Хуҷанд, кӯч. Гагарин 21", "ш. Кӯлоб, кӯч. Борбад 11"},
			"Дата_открытия":         []string{"2010-01-15", "2012-03-10", "2013-06-25", "2014-09-05", "2015-11-20", "2016-02-14", "2017-04-18", "2018-07-22", "2019-10-30", "2020-12-12", "2021-08-08"},
			"Почтовый_индекс":       []string{"734001", "734002", "734003", "734004", "734005", "735100", "735200", "735300", "735400", "735500", "735600"},
			"Короткое_наименование": []string{"Марказӣ", "И. Сомонӣ", "Фирдавсӣ", "Сино", "Шоҳмансур", "Вахдат", "Ҳисор", "Турсунзода", "Бохтар", "Хуҷанд", "Кӯлоб"},
			"Статус":                []string{"актив", "актив", "актив", "актив", "актив", "актив", "актив", "актив", "актив", "актив", "актив"},
		})
	})

	// api/handbook/cbo-offices
	r.GET("/api/handbook/cbo-offices", func(c *gin.Context) {
		c.JSON(http.StatusOK, gin.H{
			"Наименование":  []string{"КБО Марказӣ", "КБО Исмоили Сомонӣ", "КБО Фирдавсӣ", "КБО Сино", "КБО Шоҳмансур", "КБО Вахдат", "КБО Ҳисор", "КБО Турсунзода", "КБО Бохтар", "КБО Хуҷанд", "КБО Кӯлоб", "КБО Рӯдакӣ", "КБО Спитамен", "КБО Панҷакент", "КБО Истаравшан", "КБО Файзобод", "КБО Ёвон", "КБО Данғара"},
			"Адрес":         []string{"ш. Душанбе, кӯч. Рӯдакӣ 123", "ш. Душанбе, кӯч. Исмоили Сомонӣ 45", "ш. Душанбе, кӯч. Фирдавсӣ 67", "ш. Душанбе, кӯч. Сино 89", "ш. Душанбе, кӯч. Шоҳмансур 12", "ш. Вахдат, кӯч. Истиқлол 34", "ш. Ҳисор, кӯч. Наврӯз 56", "ш. Турсунзода, кӯч. Дӯстӣ 78", "ш. Бохтар, кӯч. Садриддин Айнӣ 90", "ш. Хуҷанд, кӯч. Гагарин 21", "ш. Кӯлоб, кӯч. Борбад 11", "ш. Рӯдакӣ, кӯч. Сомон 15", "ш. Спитамен, кӯч. Истиқлол 22", "ш. Панҷакент, кӯч. Рӯдакӣ 33", "ш. Истаравшан, кӯч. Фирдавсӣ 44", "ш. Файзобод, кӯч. Наврӯз 55", "ш. Ёвон, кӯч. Дӯстӣ 66", "ш. Данғара, кӯч. Истиқлол 77"},
			"Дата_открытия": []string{"2010-01-15", "2012-03-10", "2013-06-25", "2014-09-05", "2015-11-20", "2016-02-14", "2017-04-18", "2018-07-22", "2019-10-30", "2020-12-12", "2021-08-08", "2011-04-19", "2013-07-23", "2015-10-11", "2017-03-17", "2018-06-29", "2019-09-14", "2022-02-28"},
			"Филиал":        []string{"Филиали марказӣ", "Филиали Исмоили Сомонӣ", "Филиали Фирдавсӣ", "Филиали Сино", "Филиали Шоҳмансур", "Филиали Вахдат", "Филиали Ҳисор", "Филиали Турсунзода", "Филиали Бохтар", "Филиали Хуҷанд", "Филиали Кӯлоб", "Филиали Рӯдакӣ", "Филиали Спитамен", "Филиали Панҷакент", "Филиали Истаравшан", "Филиали Файзобод", "Филиали Ёвон", "Филиали Данғара"},
			"Статус":        []string{"актив", "актив", "актив", "актив", "актив", "актив", "актив", "актив", "актив", "актив", "актив", "актив", "актив", "актив", "актив", "актив", "актив", "актив"},
		})
	})

	// api/handbook/positions
	r.GET("/api/handbook/positions", func(c *gin.Context) {
		c.JSON(http.StatusOK, gin.H{
			"Наименование": []string{
				"Системный администратор",
				"Специалист службы поддержки",
				"Руководитель отдела IT",
				"Бухгалтер",
				"Юрист",
				"Менеджер по персоналу",
				"Аналитик",
				"Оператор call-центра",
				"Технический директор",
				"Эксперт по безопасности",
			},
		})
	})

	// api/handbook/roles
	r.GET("/api/handbook/roles", func(c *gin.Context) {
		c.JSON(http.StatusOK, gin.H{
			"Наименование": []string{"super admin", "admin", "user", "view_auditor", "executor"},
			"Описание":     []string{"Полный доступ ко всем функциям и настройкам системы", "Администрирование пользователей и основных настроек", "Обычный пользователь системы", "Аудитор с правом только просмотра", "Исполнитель заявок"},
		})
	})

	// api/handbook/priveleges
	r.GET("/api/handbook/priveleges", func(c *gin.Context) {
		c.JSON(http.StatusOK, gin.H{
			"Наименование": []string{"Просмотр заявок", "Создание заявок", "Редактирование заявок", "Удаление заявок", "Управление пользователями", "Просмотр отчетов", "Экспорт данных", "Настройка справочников", "Администрирование системы"},
			"Описание":     []string{"Возможность просматривать все заявки в системе", "Возможность создавать новые заявки", "Возможность редактировать существующие заявки", "Возможность удалять заявки", "Управление учетными записями пользователей и их ролями", "Просмотр аналитических и статистических отчетов", "Экспортировать данные в различные форматы", "Добавление и изменение справочной информации", "Доступ к административным функциям и настройкам системы"},
		})
	})

	// /api/equipments/atms
	r.GET("/api/equipments/atms", func(c *gin.Context) {
		c.JSON(http.StatusOK, gin.H{
			"Номер банкомата":  []string{"123456", "234567", "345678", "456789", "567890"},
			"Филиал":           []string{"Филиали марказӣ", "Филиали Исмоили Сомонӣ", "Филиали Фирдавсӣ", "Филиали Сино", "Филиали Шоҳмансур"},
			"Подразделение":    []string{"Отдел IT", "Финансовый отдел", "Отдел кадров", "Юридический отдел", "Отдел IT"},
			"Адрес_банкомата":  []string{"ш. Душанбе, кӯч. Рӯдакӣ 123", "ш. Душанбе, кӯч. Исмоили Сомонӣ 45", "ш. Душанбе, кӯч. Фирдавсӣ 67", "ш. Душанбе, кӯч. Сино 89", "ш. Душанбе, кӯч. Шоҳмансур 12"},
			"Тип_оборудования": []string{"АТМ NCR", "АТМ Diebold", "АТМ Wincor", "АТМ GRG", "АТМ Hyosung"},
		})
	})

	// /api/equipments/terminals
	r.GET("/api/equipments/terminals", func(c *gin.Context) {
		c.JSON(http.StatusOK, gin.H{
			"Номер терминала":  []string{"T-1001", "T-1002", "T-1003", "T-1004", "T-1005"},
			"Филиал":           []string{"Филиали марказӣ", "Филиали Исмоили Сомонӣ", "Филиали Фирдавсӣ", "Филиали Сино", "Филиали Шоҳмансур"},
			"Подразделение":    []string{"Отдел IT", "Финансовый отдел", "Отдел кадров", "Юридический отдел", "Отдел IT"},
			"Адрес_терминала":  []string{"ш. Душанбе, кӯч. Рӯдакӣ 123", "ш. Душанбе, кӯч. Исмоили Сомонӣ 45", "ш. Душанбе, кӯч. Фирдавсӣ 67", "ш. Душанбе, кӯч. Сино 89", "ш. Душанбе, кӯч. Шоҳмансур 12"},
			"Тип_оборудования": []string{"Терминал Verifone", "Терминал Ingenico", "Терминал PAX", "Терминал Atos", "Терминал Nexgo"},
		})
	})

	// /api/equipments/pos-terminals
	r.GET("/api/equipments/pos-terminals", func(c *gin.Context) {
		c.JSON(http.StatusOK, gin.H{
			"Номер POS-терминала": []string{"POS-2001", "POS-2002", "POS-2003", "POS-2004", "POS-2005"},
			"Филиал":              []string{"Филиали марказӣ", "Филиали Исмоили Сомонӣ", "Филиали Фирдавсӣ", "Филиали Сино", "Филиали Шоҳмансур"},
			"Подразделение":       []string{"Отдел IT", "Финансовый отдел", "Отдел кадров", "Юридический отдел", "Отдел IT"},
			"Адрес_POS-терминала": []string{"ш. Душанбе, кӯч. Рӯдакӣ 123", "ш. Душанбе, кӯч. Исмоили Сомонӣ 45", "ш. Душанбе, кӯч. Фирдавсӣ 67", "ш. Душанбе, кӯч. Сино 89", "ш. Душанбе, кӯч. Шоҳмансур 12"},
			"Тип_оборудования":    []string{"POS Verifone", "POS Ingenico", "POS PAX", "POS Atos", "POS Nexgo"},
		})
	})

	// /api/equipments/co-eos
	r.GET("/api/equipments/co-eos", func(c *gin.Context) {
		c.JSON(http.StatusOK, gin.H{
			"Номер CO-EO":      []string{"CO-3001", "CO-3002", "CO-3003", "CO-3004", "CO-3005"},
			"Филиал":           []string{"Филиали марказӣ", "Филиали Исмоили Сомонӣ", "Филиали Фирдавсӣ", "Филиали Сино", "Филиали Шоҳмансур"},
			"Подразделение":    []string{"Отдел IT", "Финансовый отдел", "Отдел кадров", "Юридический отдел", "Отдел IT"},
			"Адрес_CO-EO":      []string{"ш. Душанбе, кӯч. Рӯдакӣ 123", "ш. Душанбе, кӯч. Исмоили Сомонӣ 45", "ш. Душанбе, кӯч. Фирдавсӣ 67", "ш. Душанбе, кӯч. Сино 89", "ш. Душанбе, кӯч. Шоҳмансур 12"},
			"Тип_оборудования": []string{"CO-EO NCR", "CO-EO Diebold", "CO-EO Wincor", "CO-EO GRG", "CO-EO Hyosung"},
		})
	})

	r.Run(":8080")
}
